<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Flask官网给的博客教程 | Water</title><meta name="author" content="Da Bai"><meta name="copyright" content="Da Bai"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Flask官网给的博客教程">
<meta property="og:type" content="article">
<meta property="og:title" content="Flask官网给的博客教程">
<meta property="og:url" content="https://zxlm2013.github.io/post/66ba01.html">
<meta property="og:site_name" content="Water">
<meta property="og:description" content="Flask官网给的博客教程">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zxlm2013.github.io/photos/flaskr_login.png">
<meta property="article:published_time" content="2023-05-28T01:38:56.000Z">
<meta property="article:modified_time" content="2023-05-28T02:04:55.768Z">
<meta property="article:author" content="Da Bai">
<meta property="article:tag" content="flask">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zxlm2013.github.io/photos/flaskr_login.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zxlm2013.github.io/post/66ba01.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"3DCES81F7P","apiKey":"bece64b10be800516362a5e05953731c","indexName":"water-butterfly-blog","hits":{"per_page":10,"labels":null,"input_placeholder":"Search for Posts","hits_empty":"我们没有找到任何搜索结果: ${query}","hits_stats":"找到${hits}条结果（用时${time} ms）"},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Da Bai","link":"链接: ","source":"来源: Water","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Flask官网给的博客教程',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-28 10:04:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/photos/avatar-bw.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">32</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-fw fas fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/post/9ba41aa1.html"><i class="fa-fw fa-solid fa-table"></i><span> EXCEL</span></a></li><li><a class="site-page child" href="/post/a1042c07.html"><i class="fa-fw fa-brands fa-ubuntu"></i><span> ubuntu</span></a></li><li><a class="site-page child" href="/post/c00b24b1.html"><i class="fa-fw fa-brands fa-python"></i><span> python</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Water"><span class="site-name">Water</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-fw fas fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/post/9ba41aa1.html"><i class="fa-fw fa-solid fa-table"></i><span> EXCEL</span></a></li><li><a class="site-page child" href="/post/a1042c07.html"><i class="fa-fw fa-brands fa-ubuntu"></i><span> ubuntu</span></a></li><li><a class="site-page child" href="/post/c00b24b1.html"><i class="fa-fw fa-brands fa-python"></i><span> python</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Flask官网给的博客教程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-05-28T01:38:56.000Z" title="发表于 2023-05-28 09:38:56">2023-05-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-05-28T02:04:55.768Z" title="更新于 2023-05-28 10:04:55">2023-05-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Flask/">Flask</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>39分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Flask官网给的博客教程"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h2 id="0-简介"><a href="#0-简介" class="headerlink" title="0. 简介"></a>0. 简介</h2><p>官网中文教程地址：<a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/tutorial/index.html">https://dormousehole.readthedocs.io/en/latest/tutorial/index.html</a></p>
<p>官网英文教程地址：<a target="_blank" rel="noopener" href="https://flask.palletsprojects.com/en/2.3.x/tutorial/">https://flask.palletsprojects.com/en/2.3.x/tutorial/</a></p>
<p>官网上的教程必须好好学习，消化！</p>
<p>这篇教程中我们将会创建一个名为 <code>Flaskr</code> 的具备基本功能的博客应用。应用用户可以注册、登录、发贴和编辑或者删除自己的帖子。可以打包这个应用并且安装到其他电脑上。</p>
<p>Contents:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/tutorial/layout.html">项目布局</a></li>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/tutorial/factory.html">应用设置</a></li>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/tutorial/database.html">定义和操作数据库</a></li>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/tutorial/views.html">蓝图和视图</a></li>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/tutorial/templates.html">模板</a></li>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/tutorial/static.html">静态文件</a></li>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/tutorial/blog.html">博客蓝图</a></li>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/tutorial/install.html">项目可安装化</a></li>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/tutorial/tests.html">测试覆盖</a></li>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/tutorial/deploy.html">部署产品</a></li>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/tutorial/next.html">继续开发！</a></li>
</ul>
<h2 id="1-项目布局"><a href="#1-项目布局" class="headerlink" title="1. 项目布局"></a>1. 项目布局</h2><p>创建并进入项目文件夹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> flask-tutorial</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> flask-tutorial</span></span><br></pre></td></tr></table></figure>

<p>按照 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/installation.html">安装简介</a> 设置设置一个虚拟环境(需要提前安装好python)，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">python -m venv venv</span></span><br></pre></td></tr></table></figure>

<p>然后在虚拟环境中安装flask。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入虚拟环境</span></span><br><span class="line">venv\Scripts\activate</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装flask</span></span><br><span class="line">pip install flask</span><br></pre></td></tr></table></figure>

<div class="note info no-icon flat"><p>注意：本教程假定项目文件夹名称为 <code>flask-tutorial</code> ，<br>本教程中代码块的顶端的文件名是基于该文件夹的<strong>相对路径</strong>名称。</p>
</div>



<hr>
<p>一个最简单的 Flask 应用可以是单个文件。</p>
<p><font size=2>hello.py</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, World!&#x27;</span></span><br></pre></td></tr></table></figure>

<p>然而，当项目越来越大的时候，把所有代码放在单个文件中就有点不堪重负了。 Python 项目使用 <em><strong>包</strong></em> 来管理代码，把代码分为不同的模块，然后在需要的地方导入 模块。本教程也会按这一方式管理代码。</p>
<p>教程项目包含如下内容:</p>
<ul>
<li><code>flaskr/</code> ，一个包含应用代码和文件的 Python 包。</li>
<li><code>tests/</code> ，一个包含测试模块的文件夹。</li>
<li><code>venv/</code> ，一个 Python 虚拟环境，用于安装 Flask 和其他依赖的包。</li>
<li>告诉 Python 如何安装项目的安装文件。</li>
<li>版本控制配置，如 <a target="_blank" rel="noopener" href="https://git-scm.com/">git</a> 。不管项目大小，应当养成使用版本控制的习惯。</li>
<li>项目需要的其他文件。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">/home/user/Projects/flask-tutorial</span><br><span class="line">├── flaskr/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── db.py</span><br><span class="line">│   ├── schema.sql</span><br><span class="line">│   ├── auth.py</span><br><span class="line">│   ├── blog.py</span><br><span class="line">│   ├── templates/</span><br><span class="line">│   │   ├── base.html</span><br><span class="line">│   │   ├── auth/</span><br><span class="line">│   │   │   ├── login.html</span><br><span class="line">│   │   │   └── register.html</span><br><span class="line">│   │   └── blog/</span><br><span class="line">│   │       ├── create.html</span><br><span class="line">│   │       ├── index.html</span><br><span class="line">│   │       └── update.html</span><br><span class="line">│   └── static/</span><br><span class="line">│       └── style.css</span><br><span class="line">├── tests/</span><br><span class="line">│   ├── conftest.py</span><br><span class="line">│   ├── data.sql</span><br><span class="line">│   ├── test_factory.py</span><br><span class="line">│   ├── test_db.py</span><br><span class="line">│   ├── test_auth.py</span><br><span class="line">│   └── test_blog.py</span><br><span class="line">├── venv/</span><br><span class="line">├── setup.py</span><br><span class="line">└── MANIFEST.in</span><br></pre></td></tr></table></figure>

<p>如果使用了版本控制，那么应当忽略运行项目时产生的临时文件以及编辑代码时编辑器产生的临时文件。<strong>忽略文件的基本原则是：不是你自己写的文件就可以忽略</strong>。举例来说，假设使用 git 来进行版本控制，那么使用 <code>.gitignore</code> 来设置应当忽略的文件， <code>.gitignore</code> 文件应当与下面类似:</p>
<p><font size=2>.gitignore</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">venv/</span><br><span class="line"></span><br><span class="line">*.pyc</span><br><span class="line">__pycache__/</span><br><span class="line"></span><br><span class="line">instance/</span><br><span class="line"></span><br><span class="line">.pytest_cache/</span><br><span class="line">.coverage</span><br><span class="line">htmlcov/</span><br><span class="line"></span><br><span class="line">dist/</span><br><span class="line">build/</span><br><span class="line">*.egg-info/</span><br></pre></td></tr></table></figure>

<h2 id="2-应用设置"><a href="#2-应用设置" class="headerlink" title="2. 应用设置"></a>2. 应用设置</h2><p>一个 Flask 应用是一个 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Flask"><code>Flask</code></a> 类的实例。应用的所有东西（例如配置和URL）都会和这个实例一起注册。</p>
<p>创建一个 Flask 应用最粗暴直接的方法是在代码的最开始创建一个全局 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Flask"><code>Flask</code></a> 实例。前面的 “Hello, World!” 示例就是这样做的。有的情况下这样做是简单和有效的，但是当项目越来越大的时候就会有些力不从心了。</p>
<p><strong>可以在一个函数内部创建 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Flask"><code>Flask</code></a> 实例来代替创建全局实例</strong>。这个函数被 称为 <em><strong>应用工厂</strong></em> 。<strong>所有应用相关的配置、注册和其他设置都会在函数内部完成，然后返回这个应用</strong>。</p>
<h3 id="2-1-应用工厂"><a href="#2-1-应用工厂" class="headerlink" title="2.1 应用工厂"></a>2.1 应用工厂</h3><p>写代码的时候到了！创建 <code>flaskr</code> 文件夹并且文件夹内添加<code>__init__.py</code> 文件。 <strong><code>__init__.py</code></strong> 有两个作用：</p>
<ul>
<li><p>包含应用工厂；</p>
</li>
<li><p><strong>告诉 Python  <code>flaskr</code> 文件夹应当视作为一个包</strong>。</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> flaskr</span></span><br></pre></td></tr></table></figure>

<p><font size=2><code>flaskr/__init__.py</code></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_app</span>(<span class="params">test_config=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="comment"># create and configure the app</span></span><br><span class="line">    app = Flask(__name__, instance_relative_config=<span class="literal">True</span>)</span><br><span class="line">    app.config.from_mapping(</span><br><span class="line">        SECRET_KEY=<span class="string">&#x27;dev&#x27;</span>,</span><br><span class="line">        DATABASE=os.path.join(app.instance_path, <span class="string">&#x27;flaskr.sqlite&#x27;</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> test_config <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># load the instance config, if it exists, when not testing</span></span><br><span class="line">        <span class="comment"># silent: set to ``True`` if you want silent failure for missing files.</span></span><br><span class="line">        app.config.from_pyfile(<span class="string">&#x27;config.py&#x27;</span>, silent=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># load the test config if passed in</span></span><br><span class="line">        app.config.from_mapping(test_config)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ensure the instance folder exists</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.makedirs(app.instance_path)</span><br><span class="line">    <span class="keyword">except</span> OSError:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># a simple page that says hello</span></span><br><span class="line"><span class="meta">    @app.route(<span class="params"><span class="string">&#x27;/hello&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Hello, World!&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>

<p><code>create_app</code> 是一个应用工厂函数，后面的教程中会用到。这个看似简单的函数其实已经做了许多事情。</p>
<ol>
<li><code>app = Flask(__name__, instance_relative_config=True)</code> 创建 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Flask"><code>Flask</code></a> 实例。<ul>
<li><code>__name__</code> 是当前 Python 模块的名称。应用需要知道在哪里设置路径，使用 <code>__name__</code> 是一个方便的方法。</li>
<li><code>instance_relative_config=True</code> 告诉应用配置文件是相对于 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/config.html#instance-folders">instance folder</a> 的相对路径。实例文件夹在 <code>flaskr</code> 包的外面，用于存放本地数据（例如配置密钥和数据 库），不应当提交到版本控制系统。</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Config.from_mapping"><code>app.config.from_mapping()</code></a> 设置一个应用的缺省配置：<ul>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/config.html#SECRET_KEY"><code>SECRET_KEY</code></a> 是被 Flask 和扩展用于保证数据安全的。在开发 过程中，为了方便可以设置为 <code>&#39;dev&#39;</code> ，但是在发布的时候应当使用一个随机值来重载它。</li>
<li><code>DATABASE</code> SQLite 数据库文件存放在路径。它位于 Flask 用于存放 实例的 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Flask.instance_path"><code>app.instance_path</code></a> 之内。下 一节会更详细地学习数据库的东西。</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Config.from_pyfile"><code>app.config.from_pyfile()</code></a> 使用 <code>config.py</code> 中的值来重载缺省配置，如果 <code>config.py</code> 存在的话。 例如，当正式部署的时候，用于设置一个正式的 <code>SECRET_KEY</code> <ul>
<li><code>test_config</code> 也会被传递给工厂，并且会替代实例配置。这样可以 实现测试和开发的配置分离，相互独立。</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/os.html#os.makedirs"><code>os.makedirs()</code></a> 可以确保 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Flask.instance_path"><code>app.instance_path</code></a> 存在。 Flask 不会自 动创建实例文件夹，但是必须确保创建这个文件夹，因为 SQLite 数据库文 件会被保存在里面。</li>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Flask.route"><code>@app.route()</code></a> 创建一个简单的路由，这样在继续教 程下面的内容前你可以先看看应用如何运行的。它创建了 URL <code>/hello</code> 和一个函数之间的关联。这个函数会返回一个响应，即一个 <code>&#39;Hello, World!&#39;</code> 字符串。</li>
</ol>
<h3 id="2-2-运行应用"><a href="#2-2-运行应用" class="headerlink" title="2.2 运行应用"></a>2.2 运行应用</h3><p>现在可以通过使用 <code>flask</code> 命令来运行应用。在终端中告诉 Flask 你的应用 在哪里，然后在开发模式下运行应用。请记住，现在还是应当在最顶层的 <code>flask-tutorial</code> 目录下，不是在 <code>flaskr</code> 包里面。</p>
<p>开发模式下，当页面出错的时候会显示一个交互调试器，并且当你修改代码保存后会重启服务器。在学习本教程的过程中，你可以一直让它保持运行，只需要刷新页面就可以了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">flask --app flaskr run --debug</span></span><br></pre></td></tr></table></figure>

<p>可以看到类似如下输出内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* Serving Flask app &quot;flaskr&quot;</span><br><span class="line">* Environment: development</span><br><span class="line">* Debug mode: on</span><br><span class="line">* Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)</span><br><span class="line">* Restarting with stat</span><br><span class="line">* Debugger is active!</span><br><span class="line">* Debugger PIN: 855-212-761</span><br></pre></td></tr></table></figure>

<p>在浏览器中访问 <a target="_blank" rel="noopener" href="http://127.0.0.1:5000/hello">http://127.0.0.1:5000/hello</a> ，就可以看到 “Hello, World!” 信息。恭喜你， Flask 网络应用成功运行了！</p>
<p>如果其他应用程序已经占用了 5000 端口，那么在启动服务的时候会看到 <code>OSError: [Errno 98]</code> 或者 <code>OSError: [WinError 10013]</code> 出错信息。 如何处理这个问题，请参阅 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/server.html#address-already-in-use">地址已被占用</a> 。</p>
<h2 id="3-定义和操作数据库"><a href="#3-定义和操作数据库" class="headerlink" title="3. 定义和操作数据库"></a>3. 定义和操作数据库</h2><p>应用使用一个 <a target="_blank" rel="noopener" href="https://sqlite.org/about.html">SQLite</a> 数据库来储存用户和博客内容。 Python 内置了 SQLite 数据库支持，相应的模块为 <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/sqlite3.html#module-sqlite3"><code>sqlite3</code></a> 。</p>
<p>使用 SQLite 的便利性在于不需要单独配置一个数据库服务器，并且 Python 提供了内置支持。但是当并发请求同时要写入时，会比较慢一点，因为每个写操作是按顺序进行的。小应用没有问题，但是大应用可能就需要考虑换成别的数据库了。</p>
<p>本教程不会详细讨论SQL 。如果你不是很熟悉SQL ，请先阅读SQLite 文档中的<a target="_blank" rel="noopener" href="https://sqlite.org/lang.html">相关内容</a> 。</p>
<h3 id="3-1-连接数据库"><a href="#3-1-连接数据库" class="headerlink" title="3.1 连接数据库"></a>3.1 连接数据库</h3><p>当使用 SQLite 数据库（包括其他多数数据库的 Python 库）时，第一件事就是创建 一个数据库的连接。所有查询和操作都要通过该连接来执行，完事后该连接关闭。</p>
<p>在网络应用中连接往往与请求绑定。在处理请求的某个时刻，连接被创建。在发送响应 之前连接被关闭。</p>
<p><font size=2><code>flaskr/db.py</code></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> click</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> current_app, g</span><br><span class="line"><span class="keyword">from</span> flask.cli <span class="keyword">import</span> with_appcontext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_db</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;db&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> g:</span><br><span class="line">        g.db = sqlite3.connect(</span><br><span class="line">            current_app.config[<span class="string">&#x27;DATABASE&#x27;</span>],</span><br><span class="line">            detect_types=sqlite3.PARSE_DECLTYPES</span><br><span class="line">        )</span><br><span class="line">        g.db.row_factory = sqlite3.Row</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> g.db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">close_db</span>(<span class="params">e=<span class="literal">None</span></span>):</span><br><span class="line">    db = g.pop(<span class="string">&#x27;db&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> db <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        db.close()</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.g"><code>g</code></a> 是一个特殊对象，独立于每一个请求。在处理请求过程中，它可以用于储存 可能多个函数都会用到的数据。把连接储存于其中，可以多次使用，而不用在同一个 请求中每次调用 <code>get_db</code> 时都创建一个新的连接。</li>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.current_app"><code>current_app</code></a> 是另一个特殊对象，该对象指向处理请求的 Flask 应用。这里 使用了应用工厂，那么在其余的代码中就不会出现应用对象。当应用创建后，在处理 一个请求时， <code>get_db</code> 会被调用。这样就需要使用 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.current_app"><code>current_app</code></a> 。</li>
<li><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/sqlite3.html#sqlite3.connect"><code>sqlite3.connect()</code></a> 建立一个数据库连接，该连接指向配置中的 <code>DATABASE</code> 指定的文件。这个文件现在还没有建立，后面会在初始化数据库的时候建立该文件。</li>
<li><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/sqlite3.html#sqlite3.Row"><code>sqlite3.Row</code></a> 告诉连接返回类似于字典的行，这样可以通过列名称来操作 数据。</li>
<li><code>close_db</code> 通过检查 <code>g.db</code> 来确定连接是否已经建立。如果连接已建立，那么 就关闭连接。以后会在应用工厂中告诉应用 <code>close_db</code> 函数，这样每次请求后就会 调用它。</li>
</ul>
<h3 id="3-2-创建表"><a href="#3-2-创建表" class="headerlink" title="3.2 创建表"></a>3.2 创建表</h3><p>在 SQLite 中，数据储存在 <em>表</em> 和 <em>列</em> 中。在储存和调取数据之前需要先创建它们。 Flaskr 会把用户数据储存在 <code>user</code> 表中，把博客内容储存在 <code>post</code> 表中。下面 创建一个文件储存用于创建空表的 SQL 命令：</p>
<p><font size=2><code>flaskr/schema.sql</code></font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE IF EXISTS user;</span><br><span class="line">DROP TABLE IF EXISTS post;</span><br><span class="line"></span><br><span class="line">CREATE TABLE user (</span><br><span class="line">  id INTEGER PRIMARY KEY AUTOINCREMENT,</span><br><span class="line">  username TEXT UNIQUE NOT NULL,</span><br><span class="line">  password TEXT NOT NULL</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">CREATE TABLE post (</span><br><span class="line">  id INTEGER PRIMARY KEY AUTOINCREMENT,</span><br><span class="line">  author_id INTEGER NOT NULL,</span><br><span class="line">  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">  title TEXT NOT NULL,</span><br><span class="line">  body TEXT NOT NULL,</span><br><span class="line">  FOREIGN KEY (author_id) REFERENCES user (id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>在 <code>db.py</code> 文件中添加 Python 函数，用于运行这个 SQL 命令：</p>
<p><font size=2><code>flaskr/db.py</code></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">init_db</span>():</span><br><span class="line">    db = get_db()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> current_app.open_resource(<span class="string">&#x27;schema.sql&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        db.executescript(f.read().decode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@click.command(<span class="params"><span class="string">&#x27;init-db&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@with_appcontext</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_db_command</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Clear the existing data and create new tables.&quot;&quot;&quot;</span></span><br><span class="line">    init_db()</span><br><span class="line">    click.echo(<span class="string">&#x27;Initialized the database.&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Flask.open_resource"><code>open_resource()</code></a> 打开一个文件，该文件名是 相对于 <code>flaskr</code> 包的。这样就不需要考虑以后应用具体部署在哪个位置。 <code>get_db</code> 返回一个数据库连接，用于执行文件中的命令。</li>
<li><a target="_blank" rel="noopener" href="https://click.palletsprojects.com/en/8.1.x/api/#click.command"><code>click.command()</code></a> 定义一个名为 <code>init-db</code> 命令行，它调用 <code>init_db</code> 函数，并为用户显示一个成功的消息。 更多关于如何写命令行的内容请参阅 doc:&#x2F;cli 。</li>
</ul>
<h3 id="3-3-在应用中注册"><a href="#3-3-在应用中注册" class="headerlink" title="3.3 在应用中注册"></a>3.3 在应用中注册</h3><p><code>close_db</code> 和 <code>init_db_command</code> 函数需要在应用实例中注册，否则无法使用。 然而，既然我们使用了工厂函数，那么在写函数的时候应用实例还无法使用。代替地， 我们写一个函数，把应用作为参数，在函数中进行注册。</p>
<p><font size=2><code>flaskr/db.py</code></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">init_app</span>(<span class="params">app</span>):</span><br><span class="line">    app.teardown_appcontext(close_db)</span><br><span class="line">    app.cli.add_command(init_db_command)</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Flask.teardown_appcontext"><code>app.teardown_appcontext()</code></a> 告诉 Flask 在返回响应后进行清理的时候调用此函数。</li>
<li><a target="_blank" rel="noopener" href="https://click.palletsprojects.com/en/8.1.x/api/#click.Group.add_command"><code>app.cli.add_command()</code></a> 添加一个新的可以与 <code>flask</code> 一起工作的命令。</li>
</ul>
<p>在工厂中导入并调用这个函数。在工厂函数中把新的代码放到 函数的尾部，返回应用代码的前面。</p>
<p><font size=2><code>flaskr/__init__.py</code></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">create_app</span>():</span><br><span class="line">    app = ...</span><br><span class="line">    <span class="comment"># existing code omitted</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> . <span class="keyword">import</span> db</span><br><span class="line">    db.init_app(app)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>

<h3 id="3-4-初始化数据库文件"><a href="#3-4-初始化数据库文件" class="headerlink" title="3.4 初始化数据库文件"></a>3.4 初始化数据库文件</h3><p>现在 <code>init-db</code> 已经在应用中注册好了，可以与 <code>flask</code> 命令一起使用了。 使用的方式与前一页的 <code>run</code> 命令类似。</p>
<p>Note:</p>
<p>如果你还在运行着前一页的服务器，那么现在要么停止该服务器，要么在新 的终端中运行这个命令。如果是新的终端请记住在进行项目文件夹并激活环 境，参见 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/installation.html">安装</a> 。同时还要像前一页所述设置 <code>FLASK_APP</code> 和 <code>FLASK_ENV</code> 。</p>
<p>运行 <code>init-db</code> 命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">flask init-db</span></span><br><span class="line">Initialized the database.</span><br></pre></td></tr></table></figure>

<p>现在会有一个 <code>flaskr.sqlite</code> 文件出现在项目所在文件夹的 <code>instance</code> 文件夹中。</p>
<h2 id="4-蓝图和视图"><a href="#4-蓝图和视图" class="headerlink" title="4. 蓝图和视图"></a>4. 蓝图和视图</h2><p>视图是一个应用对请求进行响应的函数。 Flask 通过模型把进来的请求 URL 匹配到 对应的处理视图。视图返回数据， Flask 把数据变成出去的响应。 Flask 也可以反 过来，根据视图的名称和参数生成 URL 。</p>
<h3 id="4-1-创建蓝图"><a href="#4-1-创建蓝图" class="headerlink" title="4.1 创建蓝图"></a>4.1 创建蓝图</h3><p><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Blueprint"><code>Blueprint</code></a> 是一种组织一组相关视图及其他代码的方式。与把视图及其他 代码直接注册到应用的方式不同，蓝图方式是把它们注册到蓝图，然后在工厂函数中 把蓝图注册到应用。</p>
<p>Flaskr 有两个蓝图，一个用于认证功能，另一个用于博客帖子管理。每个蓝图的代码 都在一个单独的模块中。使用博客首先需要认证，因此我们先写认证蓝图。</p>
<p><font size=2><code>flaskr/auth.py</code></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> (</span><br><span class="line">    Blueprint, flash, g, redirect, render_template, request, session, url_for</span><br><span class="line">)</span><br><span class="line"><span class="keyword">from</span> werkzeug.security <span class="keyword">import</span> check_password_hash, generate_password_hash</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flaskr.db <span class="keyword">import</span> get_db</span><br><span class="line"></span><br><span class="line">bp = Blueprint(<span class="string">&#x27;auth&#x27;</span>, __name__, url_prefix=<span class="string">&#x27;/auth&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>这里创建了一个名称为 <code>&#39;auth&#39;</code> 的 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Blueprint"><code>Blueprint</code></a> 。和应用对象一样， 蓝图需要知道是在哪里定义的，因此把 <code>__name__</code> 作为函数的第二个参数。 <code>url_prefix</code> 会添加到所有与该蓝图关联的 URL 前面。</p>
<p>使用 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Flask.register_blueprint"><code>app.register_blueprint()</code></a> 导入并注册 蓝图。新的代码放在工厂函数的尾部返回应用之前。</p>
<p><font size=2><code>flaskr/__init__.py</code></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">create_app</span>():</span><br><span class="line">    app = ...</span><br><span class="line">    <span class="comment"># existing code omitted</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> . <span class="keyword">import</span> auth</span><br><span class="line">    app.register_blueprint(auth.bp)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>

<p>认证蓝图将包括注册新用户、登录和注销视图。</p>
<h3 id="4-2-第一个视图：注册"><a href="#4-2-第一个视图：注册" class="headerlink" title="4.2 第一个视图：注册"></a>4.2 第一个视图：注册</h3><p>当用访问 <code>/auth/register</code> URL 时， <code>register</code> 视图会返回用于填写注册 内容的表单的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/HTML">HTML</a> 。当用户提交表单时，视图会验证表单内容，然后要么再次 显示表单并显示一个出错信息，要么创建新用户并显示登录页面。</p>
<p>现在只是编写视图代码，在下一页会编写生成 HTML 表单的模板。</p>
<p><font size=2><code>flaskr/auth.py</code></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bp.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>, methods=(<span class="params"><span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span></span>)</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        username = request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        password = request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">        db = get_db()</span><br><span class="line">        error = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> username:</span><br><span class="line">            error = <span class="string">&#x27;Username is required.&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="keyword">not</span> password:</span><br><span class="line">            error = <span class="string">&#x27;Password is required.&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> error <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                db.execute(</span><br><span class="line">                    <span class="string">&quot;INSERT INTO user (username, password) VALUES (?, ?)&quot;</span>,</span><br><span class="line">                    (username, generate_password_hash(password)),</span><br><span class="line">                )</span><br><span class="line">                db.commit()</span><br><span class="line">            <span class="keyword">except</span> db.IntegrityError:</span><br><span class="line">                error = <span class="string">f&quot;User <span class="subst">&#123;username&#125;</span> is already registered.&quot;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;auth.login&quot;</span>))</span><br><span class="line"></span><br><span class="line">        flash(error)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;auth/register.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>这个 <code>register</code> 视图做了以下工作：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Blueprint.route"><code>@bp.route</code></a> 关联了 URL <code>/register</code> 和 <code>register</code> 视图函数。当 Flask 收到一个指向 <code>/auth/register</code> 的请求时就会调用 <code>register</code> 视图并把其返回值作为响应。</li>
<li>如果用户提交了表单，那么 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Request.method"><code>request.method</code></a> 将会是 <code>&#39;POST&#39;</code> 。这咱情况下 会开始验证用户的输入内容。</li>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Request.form"><code>request.form</code></a> 是一个特殊类型的 <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/stdtypes.html#dict"><code>dict</code></a> ，其映射了提交表单的键和值。表单中，用户将会输入其 <code>username</code> 和 <code>password</code> 。</li>
<li>验证 <code>username</code> 和 <code>password</code> 不为空。</li>
<li>如果验证成功，就把新用户的数据插入数据库。<ul>
<li><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/sqlite3.html#sqlite3.Connection.execute"><code>db.execute</code></a> 使用了带有 <code>?</code> 占位符的 SQL 查询语句。占位符可以代替后面的元组参数中相应的值。使 用占位符的好处是会自动帮你转义输入值，以抵御 <em>SQL 注入攻击</em> 。</li>
<li>因为安全原因，不能把密码明文储存在数据库中。而是应当使用 <a target="_blank" rel="noopener" href="https://werkzeug.palletsprojects.com/en/2.1.x/utils/#werkzeug.security.generate_password_hash"><code>generate_password_hash()</code></a> 生成安全的哈希值， 再把哈希值储存到数据库中。因为查询修改了数据，所以要使用 meth:db.commit() &lt;sqlite3.Connection.commit&gt; 保存修改。</li>
<li>如果用户名已存在，会产生一个 <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/sqlite3.html#sqlite3.IntegrityError"><code>sqlite3.IntegrityError</code></a> 错误， 应当将该错误作为一个验证错误显示给用户。</li>
</ul>
</li>
<li>用户数据保存后将转到登录页面。 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.url_for"><code>url_for()</code></a> 根据登录视图的名称生成相应的 URL 。与写固定的 URL 相比， 这样做的好处是如果以后需要修改该视图相应的 URL ，那么不用修改所有涉及到 URL 的代码。 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.redirect"><code>redirect()</code></a> 为生成的 URL 生成一个重定向响应。</li>
<li>如果验证失败，那么会向用户显示一个出错信息。 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.flash"><code>flash()</code></a> 用于储存在渲染模块时可以调用的信息。</li>
<li>当用户最初访问 <code>auth/register</code> 时，或者注册出错时，应用显示一个注册 表单。 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.render_template"><code>render_template()</code></a> 会渲染一个包含 HTML 的模板。你会在教程的下一节 学习如何写这个模板。</li>
</ol>
<h3 id="4-3-登录"><a href="#4-3-登录" class="headerlink" title="4.3 登录"></a>4.3 登录</h3><p>这个视图和上述 <code>register</code> 视图原理相同。</p>
<p><font size=2><code>flaskr/auth.py</code></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bp.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=(<span class="params"><span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span></span>)</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        username = request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        password = request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">        db = get_db()</span><br><span class="line">        error = <span class="literal">None</span></span><br><span class="line">        user = db.execute(</span><br><span class="line">            <span class="string">&#x27;SELECT * FROM user WHERE username = ?&#x27;</span>, (username,)</span><br><span class="line">        ).fetchone()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            error = <span class="string">&#x27;Incorrect username.&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="keyword">not</span> check_password_hash(user[<span class="string">&#x27;password&#x27;</span>], password):</span><br><span class="line">            error = <span class="string">&#x27;Incorrect password.&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> error <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            session.clear()</span><br><span class="line">            session[<span class="string">&#x27;user_id&#x27;</span>] = user[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        flash(error)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;auth/login.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>与 <code>register</code> 有以下不同之处：</p>
<ol>
<li><p>首先需要查询用户并存放在变量中，以备后用。</p>
<p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/sqlite3.html#sqlite3.Cursor.fetchone"><code>fetchone()</code></a> 根据查询返回一个记录行。 如果查询没有结果，则返回 <code>None</code> 。后面还用到 <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/sqlite3.html#sqlite3.Cursor.fetchall"><code>fetchall()</code></a> ，它返回包括所有结果的列表。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://werkzeug.palletsprojects.com/en/2.1.x/utils/#werkzeug.security.check_password_hash"><code>check_password_hash()</code></a> 以相同的方式哈希提交的 密码并安全的比较哈希值。如果匹配成功，那么密码就是正确的。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.session"><code>session</code></a> 是一个 <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/stdtypes.html#dict"><code>dict</code></a> ，它用于储存横跨请求的值。当验证 成功后，用户的 <code>id</code> 被储存于一个新的会话中。会话数据被储存到一个 向浏览器发送的 <em>cookie</em> 中，在后继请求中，浏览器会返回它。 Flask 会安全对数据进行 <em>签名</em> 以防数据被篡改。</p>
</li>
</ol>
<p>现在用户的 <code>id</code> 已被储存在 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.session"><code>session</code></a> 中，可以被后续的请求使用。 请每个请求的开头，如果用户已登录，那么其用户信息应当被载入，以使其可用于 其他视图。</p>
<p><font size=2><code>flaskr/auth.py</code></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bp.before_app_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_logged_in_user</span>():</span><br><span class="line">    user_id = session.get(<span class="string">&#x27;user_id&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> user_id <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        g.user = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        g.user = get_db().execute(</span><br><span class="line">            <span class="string">&#x27;SELECT * FROM user WHERE id = ?&#x27;</span>, (user_id,)</span><br><span class="line">        ).fetchone()</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Blueprint.before_app_request"><code>bp.before_app_request()</code></a> 注册一个 在视图函数之前运行的函数，不论其 URL 是什么。 <code>load_logged_in_user</code> 检查用户 id 是否已经储存在 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.session"><code>session</code></a> 中，并从数据库中获取用户数据，然后储存在 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.g"><code>g.user</code></a> 中。 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.g"><code>g.user</code></a> 的持续时间比请求要长。 如果没有用户 id ，或者 id 不存在，那么 <code>g.user</code> 将会是 <code>None</code> 。</p>
<h3 id="4-4-注销"><a href="#4-4-注销" class="headerlink" title="4.4 注销"></a>4.4 注销</h3><p>注销的时候需要把用户 id 从 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.session"><code>session</code></a> 中移除。 然后 <code>load_logged_in_user</code> 就不会在后继请求中载入用户了。</p>
<p><font size=2><code>flaskr/auth.py</code></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bp.route(<span class="params"><span class="string">&#x27;/logout&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    session.clear()</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h3 id="4-5-在其他视图中验证"><a href="#4-5-在其他视图中验证" class="headerlink" title="4.5 在其他视图中验证"></a>4.5 在其他视图中验证</h3><p>用户登录以后才能创建、编辑和删除博客帖子。在每个视图中可以使用 <em>装饰器</em> 来完成这个工作。</p>
<p><font size=2><code>flaskr/auth.py</code></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">login_required</span>(<span class="params">view</span>):</span><br><span class="line"><span class="meta">    @functools.wraps(<span class="params">view</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapped_view</span>(<span class="params">**kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> g.user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;auth.login&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> view(**kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapped_view</span><br></pre></td></tr></table></figure>

<p>装饰器返回一个新的视图，该视图包含了传递给装饰器的原视图。新的函数检查用户 是否已载入。如果已载入，那么就继续正常执行原视图，否则就重定向到登录页面。 我们会在博客视图中使用这个装饰器。</p>
<h3 id="4-6-端点和-URL"><a href="#4-6-端点和-URL" class="headerlink" title="4.6 端点和 URL"></a>4.6 端点和 URL</h3><p><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.url_for"><code>url_for()</code></a> 函数根据视图名称和发生成 URL 。视图相关联的名称亦称为 <em>端点</em> ，缺省情况下，端点名称与视图函数名称相同。</p>
<p>例如，前文被加入应用工厂的 <code>hello()</code> 视图端点为 <code>&#39;hello&#39;</code> ，可以使用 <code>url_for(&#39;hello&#39;)</code> 来连接。如果视图有参数，后文会看到，那么可使用 <code>url_for(&#39;hello&#39;, who=&#39;World&#39;)</code> 连接。</p>
<p>当使用蓝图的时候，蓝图的名称会添加到函数名称的前面。上面的 <code>login</code> 函数 的端点为 <code>&#39;auth.login&#39;</code> ，因为它已被加入 <code>&#39;auth&#39;</code> 蓝图中。</p>
<h2 id="5-模板"><a href="#5-模板" class="headerlink" title="5. 模板"></a>5. 模板</h2><p>应用已经写好验证视图，但是如果现在运行服务器的话，无论访问哪个 URL ，都会 看到一个 <code>TemplateNotFound</code> 错误。这是因为视图调用了 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.render_template"><code>render_template()</code></a> ，但是模板还没有写。模板文件会储存在 <code>flaskr</code> 包内的 <code>templates</code> 文件夹内。</p>
<p>模板是包含静态数据和动态数据占位符的文件。模板使用指定的数据生成最终的文档。 Flask 使用 <a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/templates/">Jinja</a> 模板库来渲染模板。</p>
<p>在教程的应用中会使用模板来渲染显示在用户浏览器中的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/HTML">HTML</a> 。在 Flask 中， Jinja 被配置为 <em>自动转义</em> HTML 模板中的任何数据。即渲染用户的输入是安全的。 任何用户输入的可能出现歧意的字符，如 <code>&lt;</code> 和 <code>&gt;</code> ，会被 <em>转义</em> ，替换为 <em>安全</em> 的值。这些值在浏览器中看起来一样，但是没有副作用。</p>
<p>Jinja 看上去并且运行地很像 Python 。 Jinja 语句与模板中的静态数据通过特定的 分界符分隔。 任何位于 <code>&#123;&#123; 和 &#125;&#125;</code> 这间的东西是一个会输出到最终文档的静态式。 <code>&#123;% 和 %&#125;</code> 之间的东西表示流程控制语句，如 <code>if</code> 和 <code>for</code> 。与 Python 不同，代码块使用分界符分隔，而不是使用缩进分隔。因为代码块内的 静态文本可以会改变缩进。</p>
<h3 id="5-1-基础布局"><a href="#5-1-基础布局" class="headerlink" title="5.1 基础布局"></a>5.1 基础布局</h3><p>应用中的每一个页面主体不同，但是基本布局是相同的。每个模板会 <em>扩展</em> 同一个 基础模板并重载相应的小节，而不是重写整个 HTML 结构。</p>
<p><font size=2><code>flaskr/templates/base.html</code></font></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;% block title %&#125;&#123;% endblock %&#125; - Flaskr<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;style.css&#x27;) &#125;&#125;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nav</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Flaskr<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    &#123;% if g.user %&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; g.user[&#x27;username&#x27;] &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;auth.logout&#x27;) &#125;&#125;&quot;</span>&gt;</span>Log Out<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    &#123;% else %&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;auth.register&#x27;) &#125;&#125;&quot;</span>&gt;</span>Register<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;auth.login&#x27;) &#125;&#125;&quot;</span>&gt;</span>Log In<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;content&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">    &#123;% block header %&#125;&#123;% endblock %&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">  &#123;% for message in get_flashed_messages() %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;flash&quot;</span>&gt;</span>&#123;&#123; message &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line">  &#123;% block content %&#125;&#123;% endblock %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.g"><code>g</code></a> 在模板中自动可用。 根据 <code>g.user</code> 是否被设置（在 <code>load_logged_in_user</code> 中进行），要么显示 用户名和注销连接，要么显示注册和登录连接。 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.url_for"><code>url_for()</code></a> 也是自动可用的，可用于生成视图的 URL ，而不用手动来指定。</p>
<p>在标题下面，正文内容前面，模板会循环显示 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.get_flashed_messages"><code>get_flashed_messages()</code></a> 返回 的每个消息。在视图中使用 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.flash"><code>flash()</code></a> 来处理出错信息，在模板中就可以这样 显示出出来。</p>
<p>模板中定义三个块，这些块会被其他模板重载。</p>
<ol>
<li><code>&#123;% block title %&#125;</code> 会改变显示在浏览器标签和窗口中的标题。</li>
<li><code>&#123;% block header %&#125;</code> 类似于 <code>title</code> ，但是会改变页面的标题。</li>
<li><code>&#123;% block content %&#125;</code> 是每个页面的具体内容，如登录表单或者博客帖子。</li>
</ol>
<p>其他模板直接放在 <code>templates</code> 文件夹内。为了更好地管理文件，属于某个蓝图 的模板会被放在与蓝图同名的文件夹内。</p>
<h3 id="5-2-注册"><a href="#5-2-注册" class="headerlink" title="5.2 注册"></a>5.2 注册</h3><p><font size=2><code>flaskr/templates/auth/register.html</code></font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &#x27;base.html&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block header %&#125;</span><br><span class="line">  &lt;h1&gt;&#123;% block title %&#125;Register&#123;% endblock %&#125;&lt;/h1&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">  &lt;form method=&quot;post&quot;&gt;</span><br><span class="line">    &lt;label for=&quot;username&quot;&gt;Username&lt;/label&gt;</span><br><span class="line">    &lt;input name=&quot;username&quot; id=&quot;username&quot; required&gt;</span><br><span class="line">    &lt;label for=&quot;password&quot;&gt;Password&lt;/label&gt;</span><br><span class="line">    &lt;input type=&quot;password&quot; name=&quot;password&quot; id=&quot;password&quot; required&gt;</span><br><span class="line">    &lt;input type=&quot;submit&quot; value=&quot;Register&quot;&gt;</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p><code>&#123;% extends 'base.html' %&#125;</code> 告诉 Jinja 这个模板基于基础模板，并且需要替换 相应的块。所有替换的内容必须位于 <code>&#123;% block %&#125;</code> 标签之内。</p>
<p>一个实用的模式是把 <code>&#123;% block title %&#125;</code> 放在 <code>&#123;% block header %&#125;</code> 内部。 这里不但可以设置 <code>title</code> 块，还可以把其值作为 <code>header</code> 块的内容， 一举两得。</p>
<p><code>input</code> 标记使用了 <code>required</code> 属性。这是告诉浏览器这些字段是必填的。 如果用户使用不支持这个属性的旧版浏览器或者不是浏览器的东西创建的请求， 那么你还是要在视图中验证输入数据。总是在服务端中完全验证数据，即使客户端 已经做了一些验证，这一点非常重要。</p>
<h3 id="5-3-登录"><a href="#5-3-登录" class="headerlink" title="5.3 登录"></a>5.3 登录</h3><p>本模板除了标题和提交按钮外与注册模板相同。</p>
<p><font size=2><code>flaskr/templates/auth/login.html</code></font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &#x27;base.html&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block header %&#125;</span><br><span class="line">  &lt;h1&gt;&#123;% block title %&#125;Log In&#123;% endblock %&#125;&lt;/h1&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">  &lt;form method=&quot;post&quot;&gt;</span><br><span class="line">    &lt;label for=&quot;username&quot;&gt;Username&lt;/label&gt;</span><br><span class="line">    &lt;input name=&quot;username&quot; id=&quot;username&quot; required&gt;</span><br><span class="line">    &lt;label for=&quot;password&quot;&gt;Password&lt;/label&gt;</span><br><span class="line">    &lt;input type=&quot;password&quot; name=&quot;password&quot; id=&quot;password&quot; required&gt;</span><br><span class="line">    &lt;input type=&quot;submit&quot; value=&quot;Log In&quot;&gt;</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-4-注册一个用户"><a href="#5-4-注册一个用户" class="headerlink" title="5.4 注册一个用户"></a>5.4 注册一个用户</h3><p>现在验证模板已写好，你可以注册一个用户了。 请确定服务器还在运行（如果没有请使用 <code>flask run</code> ），然后 访问 <a target="_blank" rel="noopener" href="http://127.0.0.1:5000/auth/register">http://127.0.0.1:5000/auth/register</a> 。</p>
<p>在不填写表单的情况，尝试点击 “Register” 按钮，浏览器会显示出错信息。尝试在 <code>register.html</code> 中删除 <code>required</code> 属性后再次点击 “Register” 按钮。 页面会重载并显示来自于视图中的 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.flash"><code>flash()</code></a> 的出错信息，而不是浏览器显示 出错信息。</p>
<p>填写用户名和密码后会重定向到登录页面。尝试输入错误的用户名，或者输入正常的 用户名和错误的密码。如果登录成功，那么会看到一个出错信息，因为还没有写登录 后要转向的 <code>index</code> 视图。</p>
<h2 id="6-静态文件"><a href="#6-静态文件" class="headerlink" title="6. 静态文件"></a>6. 静态文件</h2><p>验证视图和模板已经可用了，但是看上去很朴素。可以使用一些 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/CSS">CSS</a> 给 HTML 添加点样式。样式不会改变，所以应当使用 <em>静态文件</em> ，而不是模板。</p>
<p>Flask 自动添加一个 <code>static</code> 视图，视图使用相对于 <code>flaskr/static</code> 的相对路径。 <code>base.html</code> 模板已经使用了一个 <code>style.css</code> 文件连接：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;style.css&#x27;) &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>除了 CSS ，其他类型的静态文件可以是 JavaScript 函数文件或者 logo 图片。它们 都放置于 <code>flaskr/static</code> 文件夹中，并使用 <code>url_for(&#39;static&#39;, filename=&#39;...&#39;)</code> 引用。</p>
<p>本教程不专注于如何写 CSS ，所以你只要复制以下内容到 <code>flaskr/static/style.css</code> 文件：</p>
<p><font size=2><code>flaskr/static/style.css</code></font></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">html</span> &#123; <span class="attribute">font-family</span>: sans-serif; <span class="attribute">background</span>: <span class="number">#eee</span>; <span class="attribute">padding</span>: <span class="number">1rem</span>; &#125;</span><br><span class="line"><span class="selector-tag">body</span> &#123; <span class="attribute">max-width</span>: <span class="number">960px</span>; <span class="attribute">margin</span>: <span class="number">0</span> auto; <span class="attribute">background</span>: white; &#125;</span><br><span class="line"><span class="selector-tag">h1</span> &#123; <span class="attribute">font-family</span>: serif; <span class="attribute">color</span>: <span class="number">#377ba8</span>; <span class="attribute">margin</span>: <span class="number">1rem</span> <span class="number">0</span>; &#125;</span><br><span class="line"><span class="selector-tag">a</span> &#123; <span class="attribute">color</span>: <span class="number">#377ba8</span>; &#125;</span><br><span class="line">hr &#123; <span class="attribute">border</span>: none; <span class="attribute">border-top</span>: <span class="number">1px</span> solid lightgray; &#125;</span><br><span class="line"><span class="selector-tag">nav</span> &#123; <span class="attribute">background</span>: lightgray; <span class="attribute">display</span>: flex; <span class="attribute">align-items</span>: center; <span class="attribute">padding</span>: <span class="number">0</span> <span class="number">0.5rem</span>; &#125;</span><br><span class="line"><span class="selector-tag">nav</span> <span class="selector-tag">h1</span> &#123; <span class="attribute">flex</span>: auto; <span class="attribute">margin</span>: <span class="number">0</span>; &#125;</span><br><span class="line"><span class="selector-tag">nav</span> <span class="selector-tag">h1</span> <span class="selector-tag">a</span> &#123; <span class="attribute">text-decoration</span>: none; <span class="attribute">padding</span>: <span class="number">0.25rem</span> <span class="number">0.5rem</span>; &#125;</span><br><span class="line"><span class="selector-tag">nav</span> <span class="selector-tag">ul</span>  &#123; <span class="attribute">display</span>: flex; <span class="attribute">list-style</span>: none; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>; &#125;</span><br><span class="line"><span class="selector-tag">nav</span> <span class="selector-tag">ul</span> <span class="selector-tag">li</span> <span class="selector-tag">a</span>, <span class="selector-tag">nav</span> <span class="selector-tag">ul</span> <span class="selector-tag">li</span> <span class="selector-tag">span</span>, <span class="selector-tag">header</span> <span class="selector-class">.action</span> &#123; <span class="attribute">display</span>: block; <span class="attribute">padding</span>: <span class="number">0.5rem</span>; &#125;</span><br><span class="line"><span class="selector-class">.content</span> &#123; <span class="attribute">padding</span>: <span class="number">0</span> <span class="number">1rem</span> <span class="number">1rem</span>; &#125;</span><br><span class="line"><span class="selector-class">.content</span> &gt; <span class="selector-tag">header</span> &#123; <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid lightgray; <span class="attribute">display</span>: flex; <span class="attribute">align-items</span>: flex-end; &#125;</span><br><span class="line"><span class="selector-class">.content</span> &gt; <span class="selector-tag">header</span> <span class="selector-tag">h1</span> &#123; <span class="attribute">flex</span>: auto; <span class="attribute">margin</span>: <span class="number">1rem</span> <span class="number">0</span> <span class="number">0.25rem</span> <span class="number">0</span>; &#125;</span><br><span class="line"><span class="selector-class">.flash</span> &#123; <span class="attribute">margin</span>: <span class="number">1em</span> <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">1em</span>; <span class="attribute">background</span>: <span class="number">#cae6f6</span>; <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#377ba8</span>; &#125;</span><br><span class="line"><span class="selector-class">.post</span> &gt; <span class="selector-tag">header</span> &#123; <span class="attribute">display</span>: flex; <span class="attribute">align-items</span>: flex-end; <span class="attribute">font-size</span>: <span class="number">0.85em</span>; &#125;</span><br><span class="line"><span class="selector-class">.post</span> &gt; <span class="selector-tag">header</span> &gt; <span class="selector-tag">div</span><span class="selector-pseudo">:first</span>-of-type &#123; <span class="attribute">flex</span>: auto; &#125;</span><br><span class="line"><span class="selector-class">.post</span> &gt; <span class="selector-tag">header</span> <span class="selector-tag">h1</span> &#123; <span class="attribute">font-size</span>: <span class="number">1.5em</span>; <span class="attribute">margin-bottom</span>: <span class="number">0</span>; &#125;</span><br><span class="line"><span class="selector-class">.post</span> <span class="selector-class">.about</span> &#123; <span class="attribute">color</span>: slategray; <span class="attribute">font-style</span>: italic; &#125;</span><br><span class="line"><span class="selector-class">.post</span> <span class="selector-class">.body</span> &#123; <span class="attribute">white-space</span>: pre-line; &#125;</span><br><span class="line"><span class="selector-class">.content</span><span class="selector-pseudo">:last-child</span> &#123; <span class="attribute">margin-bottom</span>: <span class="number">0</span>; &#125;</span><br><span class="line"><span class="selector-class">.content</span> <span class="selector-tag">form</span> &#123; <span class="attribute">margin</span>: <span class="number">1em</span> <span class="number">0</span>; <span class="attribute">display</span>: flex; <span class="attribute">flex-direction</span>: column; &#125;</span><br><span class="line"><span class="selector-class">.content</span> <span class="selector-tag">label</span> &#123; <span class="attribute">font-weight</span>: bold; <span class="attribute">margin-bottom</span>: <span class="number">0.5em</span>; &#125;</span><br><span class="line"><span class="selector-class">.content</span> <span class="selector-tag">input</span>, <span class="selector-class">.content</span> <span class="selector-tag">textarea</span> &#123; <span class="attribute">margin-bottom</span>: <span class="number">1em</span>; &#125;</span><br><span class="line"><span class="selector-class">.content</span> <span class="selector-tag">textarea</span> &#123; <span class="attribute">min-height</span>: <span class="number">12em</span>; <span class="attribute">resize</span>: vertical; &#125;</span><br><span class="line"><span class="selector-tag">input</span><span class="selector-class">.danger</span> &#123; <span class="attribute">color</span>: <span class="number">#cc2f2e</span>; &#125;</span><br><span class="line"><span class="selector-tag">input</span><span class="selector-attr">[type=submit]</span> &#123; <span class="attribute">align-self</span>: start; <span class="attribute">min-width</span>: <span class="number">10em</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>你可以在 <a target="_blank" rel="noopener" href="https://github.com/pallets/flask/tree/2.1.2/examples/tutorial/flaskr/static/style.css">示例代码</a> 找到一个排版不紧凑的 <code>style.css</code> 。</p>
<p>访问 <a target="_blank" rel="noopener" href="http://127.0.0.1:5000/auth/login">http://127.0.0.1:5000/auth/login</a> ，页面如下所示。</p>
<p><img src="/photos/flaskr_login.png" alt="flaskr_login"></p>
<p>关于 CSS 的更多内容参见 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/CSS">Mozilla 的文档</a> 。改动静态文件后需要刷新页面。如果刷新没有作用，请清除浏览器的缓存。</p>
<h2 id="7-博客蓝图"><a href="#7-博客蓝图" class="headerlink" title="7. 博客蓝图"></a>7. 博客蓝图</h2><p>博客蓝图与验证蓝图所使用的技术一样。博客页面应当列出所有的帖子，允许已登录 用户创建帖子，并允许帖子作者修改和删除帖子。</p>
<p>当你完成每个视图时，请保持开发服务器运行。当你保存修改后，请尝试在浏览器中 访问 URL ，并进行测试。</p>
<h3 id="7-1-蓝图"><a href="#7-1-蓝图" class="headerlink" title="7.1 蓝图"></a>7.1 蓝图</h3><p>定义蓝图并注册到应用工厂。</p>
<p><font size=2><code>flaskr/blog.py</code></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> (</span><br><span class="line">    Blueprint, flash, g, redirect, render_template, request, url_for</span><br><span class="line">)</span><br><span class="line"><span class="keyword">from</span> werkzeug.exceptions <span class="keyword">import</span> abort</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flaskr.auth <span class="keyword">import</span> login_required</span><br><span class="line"><span class="keyword">from</span> flaskr.db <span class="keyword">import</span> get_db</span><br><span class="line"></span><br><span class="line">bp = Blueprint(<span class="string">&#x27;blog&#x27;</span>, __name__)</span><br></pre></td></tr></table></figure>

<p>使用 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Flask.register_blueprint"><code>app.register_blueprint()</code></a> 在工厂中 导入和注册蓝图。将新代码放在工厂函数的尾部，返回应用之前。</p>
<p><font size=2><code>flaskr/__init__.py</code></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">create_app</span>():</span><br><span class="line">    app = ...</span><br><span class="line">    <span class="comment"># existing code omitted</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> . <span class="keyword">import</span> blog</span><br><span class="line">    app.register_blueprint(blog.bp)</span><br><span class="line">    app.add_url_rule(<span class="string">&#x27;/&#x27;</span>, endpoint=<span class="string">&#x27;index&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>

<p>与验证蓝图不同，博客蓝图没有 <code>url_prefix</code> 。因此 <code>index</code> 视图会用于 <code>/</code> ， <code>create</code> 会用于 <code>/create</code> ，以此类推。博客是 Flaskr 的主要 功能，因此把博客索引作为主索引是合理的。</p>
<p>但是，下文的 <code>index</code> 视图的端点会被定义为 <code>blog.index</code> 。一些验证视图 会指定向普通的 <code>index</code> 端点。 我们使用 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Flask.add_url_rule"><code>app.add_url_rule()</code></a> 关联端点名称 <code>&#39;index&#39;</code> 和 <code>/</code> URL ，这样 <code>url_for(&#39;index&#39;)</code> 或 <code>url_for(&#39;blog.index&#39;)</code> 都会有效，会生成同样的 <code>/</code> URL 。</p>
<p>在其他应用中，可能会在工厂中给博客蓝图一个 <code>url_prefix</code> 并定义一个独立的 <code>index</code> 视图，类似前文中的 <code>hello</code> 视图。在这种情况下 <code>index</code> 和 <code>blog.index</code> 的端点和 URL 会有所不同。</p>
<h3 id="7-2-索引"><a href="#7-2-索引" class="headerlink" title="7.2 索引"></a>7.2 索引</h3><p>索引会显示所有帖子，最新的会排在最前面。为了在结果中包含 <code>user</code> 表中的 作者信息，使用了一个 <code>JOIN</code> 。</p>
<p><font size=2><code>flaskr/blog.py</code></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bp.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    db = get_db()</span><br><span class="line">    posts = db.execute(</span><br><span class="line">        <span class="string">&#x27;SELECT p.id, title, body, created, author_id, username&#x27;</span></span><br><span class="line">        <span class="string">&#x27; FROM post p JOIN user u ON p.author_id = u.id&#x27;</span></span><br><span class="line">        <span class="string">&#x27; ORDER BY created DESC&#x27;</span></span><br><span class="line">    ).fetchall()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;blog/index.html&#x27;</span>, posts=posts)</span><br></pre></td></tr></table></figure>

<p><font size=2><code>flaskr/templates/blog/index.html</code></font></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &#x27;base.html&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block header %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;% block title %&#125;Posts&#123;% endblock %&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  &#123;% if g.user %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;action&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;blog.create&#x27;) &#125;&#125;&quot;</span>&gt;</span>New<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">  &#123;% for post in posts %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">article</span> <span class="attr">class</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123; post[&#x27;title&#x27;] &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;about&quot;</span>&gt;</span>by &#123;&#123; post[&#x27;username&#x27;] &#125;&#125; on &#123;&#123; post[&#x27;created&#x27;].strftime(&#x27;%Y-%m-%d&#x27;) &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        &#123;% if g.user[&#x27;id&#x27;] == post[&#x27;author_id&#x27;] %&#125;</span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;action&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;blog.update&#x27;, id=post[&#x27;id&#x27;]) &#125;&#125;&quot;</span>&gt;</span>Edit<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;body&quot;</span>&gt;</span>&#123;&#123; post[&#x27;body&#x27;] &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">article</span>&gt;</span></span><br><span class="line">    &#123;% if not loop.last %&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p>当用户登录后， <code>header</code> 块添加了一个指向 <code>create</code> 视图的连接。当用户是 博客作者时，可以看到一个“ Edit ”连接，指向 <code>update</code> 视图。 <code>loop.last</code> 是一个 <a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/templates/#for">Jinja for 循环</a> 内部可用的特殊变量，它用于在每个 博客帖子后面显示一条线来分隔帖子，最后一个帖子除外。</p>
<h3 id="7-3-创建"><a href="#7-3-创建" class="headerlink" title="7.3 创建"></a>7.3 创建</h3><p><code>create</code> 视图与 <code>register</code> 视图原理相同。要么显示表单，要么发送内容 已通过验证且内容已加入数据库，或者显示一个出错信息。</p>
<p>先前写的 <code>login_required</code> 装饰器用在了博客视图中，这样用户必须登录以后 才能访问这些视图，否则会被重定向到登录页面。</p>
<p><font size=2><code>flaskr/blog.py</code></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bp.route(<span class="params"><span class="string">&#x27;/create&#x27;</span>, methods=(<span class="params"><span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span></span>)</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        title = request.form[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">        body = request.form[<span class="string">&#x27;body&#x27;</span>]</span><br><span class="line">        error = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> title:</span><br><span class="line">            error = <span class="string">&#x27;Title is required.&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> error <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            flash(error)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            db = get_db()</span><br><span class="line">            db.execute(</span><br><span class="line">                <span class="string">&#x27;INSERT INTO post (title, body, author_id)&#x27;</span></span><br><span class="line">                <span class="string">&#x27; VALUES (?, ?, ?)&#x27;</span>,</span><br><span class="line">                (title, body, g.user[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line">            )</span><br><span class="line">            db.commit()</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;blog.index&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;blog/create.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><font size=2><code>flaskr/templates/blog/create.html</code></font></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &#x27;base.html&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block header %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;% block title %&#125;New Post&#123;% endblock %&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;title&quot;</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span> <span class="attr">id</span>=<span class="string">&quot;title&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123; request.form[&#x27;title&#x27;] &#125;&#125;&quot;</span> <span class="attr">required</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;body&quot;</span>&gt;</span>Body<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">&quot;body&quot;</span> <span class="attr">id</span>=<span class="string">&quot;body&quot;</span>&gt;</span>&#123;&#123; request.form[&#x27;body&#x27;] &#125;&#125;<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Save&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-4-更新"><a href="#7-4-更新" class="headerlink" title="7.4 更新"></a>7.4 更新</h3><p><code>update</code> 和 <code>delete</code> 视图都需要通过 <code>id</code> 来获取一个 <code>post</code> ，并且 检查作者与登录用户是否一致。为避免重复代码，可以写一个函数来获取 <code>post</code> ， 并在每个视图中调用它。</p>
<p><font size=2><code>flaskr/blog.py</code></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_post</span>(<span class="params"><span class="built_in">id</span>, check_author=<span class="literal">True</span></span>):</span><br><span class="line">    post = get_db().execute(</span><br><span class="line">        <span class="string">&#x27;SELECT p.id, title, body, created, author_id, username&#x27;</span></span><br><span class="line">        <span class="string">&#x27; FROM post p JOIN user u ON p.author_id = u.id&#x27;</span></span><br><span class="line">        <span class="string">&#x27; WHERE p.id = ?&#x27;</span>,</span><br><span class="line">        (<span class="built_in">id</span>,)</span><br><span class="line">    ).fetchone()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> post <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        abort(<span class="number">404</span>, <span class="string">f&quot;Post id <span class="subst">&#123;<span class="built_in">id</span>&#125;</span> doesn&#x27;t exist.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> check_author <span class="keyword">and</span> post[<span class="string">&#x27;author_id&#x27;</span>] != g.user[<span class="string">&#x27;id&#x27;</span>]:</span><br><span class="line">        abort(<span class="number">403</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> post</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.abort"><code>abort()</code></a> 会引发一个特殊的异常，返回一个 HTTP 状态码。它有一个可选参数， 用于显示出错信息，若不使用该参数则返回缺省出错信息。 <code>404</code> 表示“未找到”， <code>403</code> 代表“禁止访问”。（ <code>401</code> 表示“未授权”，但是我们重定向到登录 页面来代替返回这个状态码）</p>
<p><code>check_author</code> 参数的作用是函数可以用于在不检查作者的情况下获取一个 <code>post</code> 。这主要用于显示一个独立的帖子页面的情况，因为这时用户是谁没有关系， 用户不会修改帖子。</p>
<p><font size=2><code>flaskr/blog.py</code></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bp.route(<span class="params"><span class="string">&#x27;/&lt;int:id&gt;/update&#x27;</span>, methods=(<span class="params"><span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span></span>)</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    post = get_post(<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        title = request.form[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">        body = request.form[<span class="string">&#x27;body&#x27;</span>]</span><br><span class="line">        error = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> title:</span><br><span class="line">            error = <span class="string">&#x27;Title is required.&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> error <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            flash(error)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            db = get_db()</span><br><span class="line">            db.execute(</span><br><span class="line">                <span class="string">&#x27;UPDATE post SET title = ?, body = ?&#x27;</span></span><br><span class="line">                <span class="string">&#x27; WHERE id = ?&#x27;</span>,</span><br><span class="line">                (title, body, <span class="built_in">id</span>)</span><br><span class="line">            )</span><br><span class="line">            db.commit()</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;blog.index&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;blog/update.html&#x27;</span>, post=post)</span><br></pre></td></tr></table></figure>

<p>和所有以前的视图不同， <code>update</code> 函数有一个 <code>id</code> 参数。该参数对应路由中 的 <code>&lt;int:id&gt;</code> 。一个真正的 URL 类似 <code>/1/update</code> 。 Flask 会捕捉到 URL 中的 <code>1</code> ，确保其为一个 <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/functions.html#int"><code>int</code></a> ，并将其作为 <code>id</code> 参数传递给视图。 如果没有指定 <code>int:</code> 而是仅仅写了 <code>&lt;id&gt;</code> ，那么将会传递一个字符串。 要生成一个指向更新页面的 URL ，需要传递 <code>id</code> 参数给 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.url_for"><code>url_for()</code></a> ： <code>url_for(&#39;blog.update&#39;, id=post[&#39;id&#39;])</code> 。前文的 <code>index.html</code> 文件中 同样如此。</p>
<p><code>create</code> 和 <code>update</code> 视图看上去是相似的。 主要的不同之处在于 <code>update</code> 视图使用了一个 <code>post</code> 对象和一个 <code>UPDATE</code> 查询代替了一个 <code>INSERT</code> 查询。作为一个明智的重构者，可以使用 一个视图和一个模板来同时完成这两项工作。但是作为一个初学者，把它们分别处理 要清晰一些。</p>
<p><font size=2><code>flaskr/templates/blog/update.html</code></font></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &#x27;base.html&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block header %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;% block title %&#125;Edit &quot;&#123;&#123; post[&#x27;title&#x27;] &#125;&#125;&quot;&#123;% endblock %&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;title&quot;</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span> <span class="attr">id</span>=<span class="string">&quot;title&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">value</span>=<span class="string">&quot;&#123;&#123; request.form[&#x27;title&#x27;] or post[&#x27;title&#x27;] &#125;&#125;&quot;</span> <span class="attr">required</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;body&quot;</span>&gt;</span>Body<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">&quot;body&quot;</span> <span class="attr">id</span>=<span class="string">&quot;body&quot;</span>&gt;</span>&#123;&#123; request.form[&#x27;body&#x27;] or post[&#x27;body&#x27;] &#125;&#125;<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Save&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;blog.delete&#x27;, id=post[&#x27;id&#x27;]) &#125;&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;danger&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Delete&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;return confirm(&#x27;Are you sure?&#x27;);&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p>这个模板有两个表单。第一个提交已编辑过的数据给当前页面（ <code>/&lt;id&gt;/update</code> ）。 另一个表单只包含一个按钮。它指定一个 <code>action</code> 属性，指向删除视图。这个按钮 使用了一些 JavaScript 用以在提交前显示一个确认对话框。</p>
<p>参数 <code>&#123;&#123; request.form['title'] or post['title'] &#125;&#125;</code> 用于选择在表单显示什么 数据。当表单还未提交时，显示原 <code>post</code> 数据。但是，如果提交了非法数据，然后 需要显示这些非法数据以便于用户修改时，就显示 <code>request.form</code> 中的数据。 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.request"><code>request</code></a> 是又一个自动在模板中可用的变量。</p>
<h3 id="7-5-删除"><a href="#7-5-删除" class="headerlink" title="7.5 删除"></a>7.5 删除</h3><p>删除视图没有自己的模板。删除按钮已包含于 <code>update.html</code> 之中，该按钮指向 <code>/&lt;id&gt;/delete</code> URL 。既然没有模板，该视图只处理 <code>POST</code> 方法并重定向到 <code>index</code> 视图。</p>
<p><font size=2><code>flaskr/blog.py</code></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bp.route(<span class="params"><span class="string">&#x27;/&lt;int:id&gt;/delete&#x27;</span>, methods=(<span class="params"><span class="string">&#x27;POST&#x27;</span>,</span>)</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    get_post(<span class="built_in">id</span>)</span><br><span class="line">    db = get_db()</span><br><span class="line">    db.execute(<span class="string">&#x27;DELETE FROM post WHERE id = ?&#x27;</span>, (<span class="built_in">id</span>,))</span><br><span class="line">    db.commit()</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;blog.index&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>恭喜，应用写完了！花点时间在浏览器中试试这个应用吧。然而，构建一个完整的 应用还有一些工作要做。</p>
<h2 id="8-部署产品"><a href="#8-部署产品" class="headerlink" title="8. 部署产品"></a>8. 部署产品</h2><p>本文假设你要把应用部署到一个服务器上。本文只是给出如何创建发行文件并进行安 装的概览，但是不会具体讨论使用哪种服务器或者软件。你可以在用于开发的电脑中 设置一个新的虚拟环境，以便于尝试下面的内容。但是建议不要用于部署一个真正的公开应用。以多种不同方式部署应用的列表参见 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/deploying/index.html">部署方式</a> 。</p>
<h3 id="8-1-配置密钥"><a href="#8-1-配置密钥" class="headerlink" title="8.1 配置密钥"></a>8.1 配置密钥</h3><p>在教程开始的时候给了 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/config.html#SECRET_KEY"><code>SECRET_KEY</code></a> 一个缺省值。在产品中我们应当设置一 些随机内容。否则网络攻击者就可以使用公开的 <code>&#39;dev&#39;</code> 键来修改会话 cookie ，或者其他任何使用密钥的东西。</p>
<p>可以使用下面的命令输出一个随机密钥：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ python -c &#x27;import secrets; print(secrets.token_hex())</span><br><span class="line"></span><br><span class="line">&#x27;192b9bdd22ab9ed4d12e236c78afcb9a393ec15f71bbf5dc987d54727823bcbf</span><br></pre></td></tr></table></figure>

<p>在实例文件夹创建一个 <code>config.py</code> 文件。工厂会读取这个文件，如果该文件存 在的话。提制生成的值到该文件中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">venv/var/flaskr-instance/config.py</span><br><span class="line">SECRET_KEY = &#x27;192b9bdd22ab9ed4d12e236c78afcb9a393ec15f71bbf5dc987d54727823bcbf&#x27;</span><br></pre></td></tr></table></figure>

<p>其他必须的配置也可以写入该文件中。 Flaskr 只需要 <code>SECRET_KEY</code> 即可。</p>
<h3 id="8-2-运行产品服务器"><a href="#8-2-运行产品服务器" class="headerlink" title="8.2 运行产品服务器"></a>8.2 运行产品服务器</h3><p>当运行公开服务器而不是进行开发的时候，应当不使用内建的开发服务器 （ <code>flask run</code> ）。开发服务器由 Werkzeug 提供，目的是为了方便开发，但是 不够高效、稳定和安全。</p>
<p>替代地，应当选用一个产品级的 WSGI 服务器。例如，使用 <a target="_blank" rel="noopener" href="https://docs.pylonsproject.org/projects/waitress/en/stable/">Waitress</a> 。首先在 虚拟环境中安装它：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pip install waitress</span></span><br></pre></td></tr></table></figure>

<p>需要把应用告知 Waitree ，但是方式与 <code>flask run</code> 那样使用 <code>FLASK_APP</code> 不同。需要告知 Waitree 导入并调用应用工厂来得到一个应用对象。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">waitress-serve --call flaskr:create_app</span></span><br><span class="line"></span><br><span class="line">Serving on http://0.0.0.0:8080</span><br></pre></td></tr></table></figure>

<p>以多种不同方式部署应用的列表参见 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/deploying/index.html">部署方式</a> 。使用 Waitress 只是一个示例，选择它是因为它同时支持 Windows 和 Linux 。还有其他许多 WSGI 服务器和部署选项可供选择。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://zxlm2013.github.io">Da Bai</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zxlm2013.github.io/post/66ba01.html">https://zxlm2013.github.io/post/66ba01.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zxlm2013.github.io" target="_blank">Water</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/flask/">flask</a></div><div class="post_share"><div class="social-share" data-image="/photos/flaskr_login.png" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/photos/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/photos/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/photos/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/photos/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/post/24940f62.html" title="Web前端技术笔记"><img class="cover" src="/photos/chrome_logo.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Web前端技术笔记</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/28eb9e4f.html" title="Flask笔记"><img class="cover" src="/photos/flask_logo.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-16</div><div class="title">Flask笔记</div></div></a></div><div><a href="/post/4c09bf72.html" title="Flask蓝图"><img class="cover" src="/photos/flask_logo.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-10</div><div class="title">Flask蓝图</div></div></a></div><div><a href="/post/d2f81b28.html" title="flask开发留言板"><img class="cover" src="/photos/flask_logo.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-26</div><div class="title">flask开发留言板</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/photos/avatar-bw.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Da Bai</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">32</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zxlm2013"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/zxlm2013" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1027983475@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-%E7%AE%80%E4%BB%8B"><span class="toc-text">0. 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%A1%B9%E7%9B%AE%E5%B8%83%E5%B1%80"><span class="toc-text">1. 项目布局</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%BA%94%E7%94%A8%E8%AE%BE%E7%BD%AE"><span class="toc-text">2. 应用设置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%BA%94%E7%94%A8%E5%B7%A5%E5%8E%82"><span class="toc-text">2.1 应用工厂</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E8%BF%90%E8%A1%8C%E5%BA%94%E7%94%A8"><span class="toc-text">2.2 运行应用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%AE%9A%E4%B9%89%E5%92%8C%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">3. 定义和操作数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">3.1 连接数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%88%9B%E5%BB%BA%E8%A1%A8"><span class="toc-text">3.2 创建表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%9C%A8%E5%BA%94%E7%94%A8%E4%B8%AD%E6%B3%A8%E5%86%8C"><span class="toc-text">3.3 在应用中注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%BA%93%E6%96%87%E4%BB%B6"><span class="toc-text">3.4 初始化数据库文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%93%9D%E5%9B%BE%E5%92%8C%E8%A7%86%E5%9B%BE"><span class="toc-text">4. 蓝图和视图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%88%9B%E5%BB%BA%E8%93%9D%E5%9B%BE"><span class="toc-text">4.1 创建蓝图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E7%AC%AC%E4%B8%80%E4%B8%AA%E8%A7%86%E5%9B%BE%EF%BC%9A%E6%B3%A8%E5%86%8C"><span class="toc-text">4.2 第一个视图：注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E7%99%BB%E5%BD%95"><span class="toc-text">4.3 登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E6%B3%A8%E9%94%80"><span class="toc-text">4.4 注销</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E5%9C%A8%E5%85%B6%E4%BB%96%E8%A7%86%E5%9B%BE%E4%B8%AD%E9%AA%8C%E8%AF%81"><span class="toc-text">4.5 在其他视图中验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E7%AB%AF%E7%82%B9%E5%92%8C-URL"><span class="toc-text">4.6 端点和 URL</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%A8%A1%E6%9D%BF"><span class="toc-text">5. 模板</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%9F%BA%E7%A1%80%E5%B8%83%E5%B1%80"><span class="toc-text">5.1 基础布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E6%B3%A8%E5%86%8C"><span class="toc-text">5.2 注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E7%99%BB%E5%BD%95"><span class="toc-text">5.3 登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E6%B3%A8%E5%86%8C%E4%B8%80%E4%B8%AA%E7%94%A8%E6%88%B7"><span class="toc-text">5.4 注册一个用户</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6"><span class="toc-text">6. 静态文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E5%8D%9A%E5%AE%A2%E8%93%9D%E5%9B%BE"><span class="toc-text">7. 博客蓝图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E8%93%9D%E5%9B%BE"><span class="toc-text">7.1 蓝图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E7%B4%A2%E5%BC%95"><span class="toc-text">7.2 索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-%E5%88%9B%E5%BB%BA"><span class="toc-text">7.3 创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-%E6%9B%B4%E6%96%B0"><span class="toc-text">7.4 更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-%E5%88%A0%E9%99%A4"><span class="toc-text">7.5 删除</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E9%83%A8%E7%BD%B2%E4%BA%A7%E5%93%81"><span class="toc-text">8. 部署产品</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E9%85%8D%E7%BD%AE%E5%AF%86%E9%92%A5"><span class="toc-text">8.1 配置密钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E8%BF%90%E8%A1%8C%E4%BA%A7%E5%93%81%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">8.2 运行产品服务器</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/66ba01.html" title="Flask官网给的博客教程"><img src="/photos/flaskr_login.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Flask官网给的博客教程"/></a><div class="content"><a class="title" href="/post/66ba01.html" title="Flask官网给的博客教程">Flask官网给的博客教程</a><time datetime="2023-05-28T01:38:56.000Z" title="发表于 2023-05-28 09:38:56">2023-05-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/24940f62.html" title="Web前端技术笔记"><img src="/photos/chrome_logo.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Web前端技术笔记"/></a><div class="content"><a class="title" href="/post/24940f62.html" title="Web前端技术笔记">Web前端技术笔记</a><time datetime="2023-05-23T12:24:17.000Z" title="发表于 2023-05-23 20:24:17">2023-05-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/4c09bf72.html" title="Flask蓝图"><img src="/photos/flask_logo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Flask蓝图"/></a><div class="content"><a class="title" href="/post/4c09bf72.html" title="Flask蓝图">Flask蓝图</a><time datetime="2023-05-10T10:31:07.000Z" title="发表于 2023-05-10 18:31:07">2023-05-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/d2f81b28.html" title="flask开发留言板"><img src="/photos/flask_logo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="flask开发留言板"/></a><div class="content"><a class="title" href="/post/d2f81b28.html" title="flask开发留言板">flask开发留言板</a><time datetime="2023-04-26T10:13:46.000Z" title="发表于 2023-04-26 18:13:46">2023-04-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/28eb9e4f.html" title="Flask笔记"><img src="/photos/flask_logo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Flask笔记"/></a><div class="content"><a class="title" href="/post/28eb9e4f.html" title="Flask笔记">Flask笔记</a><time datetime="2023-04-16T12:24:25.000Z" title="发表于 2023-04-16 20:24:25">2023-04-16</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 By Da Bai</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my blog!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><div class="aplayer no-destroy" data-id="8210247415" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true"> </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/algoliasearch-lite.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script></div></body></html>